<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <title>Tasks - Earn DOGS</title>
  <meta name="viewport" content="width=340, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      color: #ffffff;
      font-family: 'Inter', Arial, sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
      font-size: 13px;
    }
    .container {
      width: 340px;
      margin: 0 auto;
      padding: 12px 8px 90px 8px;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 14px;
      padding: 14px;
      text-align: center;
      margin-bottom: 14px;
      box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
      border: 1px solid rgba(255,255,255,0.1);
    }
    .header-title {
      font-size: 1em;
      font-weight: 700;
      letter-spacing: 1px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .balance-display {
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(10px);
      border-radius: 14px;
      padding: 12px 16px;
      margin-bottom: 16px;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .balance-label {
      font-size: 0.95em;
      font-weight: 600;
      color: #f0f0f0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .balance-value {
      font-size: 1.1em;
      font-weight: 700;
      color: #4ade80;
    }
    .tasks-section {
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(10px);
      border-radius: 14px;
      padding: 16px;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      margin-bottom: 16px;
    }
    .section-title {
      font-size: 0.95em;
      font-weight: 600;
      margin-bottom: 12px;
      color: #f0f0f0;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .create-btn {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.8em;
      font-weight: 600;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(239,68,68,0.3);
    }
    .create-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(239,68,68,0.4);
    }
    .task-item {
      background: rgba(255,255,255,0.03);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 10px;
      border: 1px solid rgba(255,255,255,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .task-info {
      flex: 1;
    }
    .task-title {
      font-size: 0.95em;
      font-weight: 600;
      color: #f0f0f0;
      margin-bottom: 4px;
    }
    .task-reward {
      font-size: 0.85em;
      color: #4ade80;
      font-weight: 500;
    }
    .task-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-size: 0.9em;
      font-weight: 600;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.3s;
      min-width: 80px;
    }
    .earn-btn {
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(59,130,246,0.3);
    }
    .earn-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59,130,246,0.4);
    }
    .join-btn {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(139,92,246,0.3);
    }
    .join-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(139,92,246,0.4);
    }
    .countdown-btn {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      cursor: not-allowed;
      box-shadow: 0 2px 8px rgba(245,158,11,0.3);
    }
    .claim-btn {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(16,185,129,0.3);
      animation: pulse 2s infinite;
    }
    .claim-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(16,185,129,0.4);
    }
    .claimed-btn {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
      color: #d1d5db;
      cursor: not-allowed;
      box-shadow: none;
    }
    .no-tasks {
      text-align: center;
      color: #9ca3af;
      font-weight: 500;
      padding: 20px;
      font-size: 0.95em;
      letter-spacing: 0.5px;
    }

    /* Promo Code Section Styles */
    .promo-input-container {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .promo-input {
      flex: 1;
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.05);
      color: #fff;
      font-size: 0.9em;
      outline: none;
      transition: all 0.3s;
      text-transform: uppercase;
    }
    .promo-input:focus {
      border-color: #8b5cf6;
      background: rgba(255,255,255,0.1);
      box-shadow: 0 0 0 2px rgba(139,92,246,0.2);
    }
    .promo-input::placeholder {
      color: #9ca3af;
      text-transform: none;
    }
    .promo-btn {
      padding: 10px 20px;
      border-radius: 12px;
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      border: none;
      color: white;
      font-weight: 600;
      cursor: pointer;
      text-transform: uppercase;
      box-shadow: 0 2px 8px rgba(139,92,246,0.3);
      transition: all 0.3s;
      font-size: 0.9em;
      letter-spacing: 0.5px;
    }
    .promo-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(139,92,246,0.4);
    }
    .promo-btn:disabled {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 340px;
      background: rgba(0,0,0,0.9);
      backdrop-filter: blur(20px);
      border-top: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px 20px 0 0;
      padding: 16px 12px;
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 100;
    }
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      padding: 8px 8px;
      border-radius: 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      min-width: 50px;
      flex: 1;
      margin: 0 2px;
    }
    .nav-item:hover {
      background: rgba(255,255,255,0.1);
      transform: translateY(-2px);
    }
    .nav-item.active {
      background: rgba(102,126,234,0.2);
      border-color: rgba(102,126,234,0.3);
    }
    .nav-icon {
      width: 22px; height: 22px; margin-bottom: 4px;
      background: #fff;
      mask-size: contain;
      mask-repeat: no-repeat;
      mask-position: center;
    }
    .nav-home .nav-icon {
      mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m3 12 2-2m0 0 7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6'/%3E%3C/svg%3E");
    }
    .nav-ads .nav-icon {
      mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z'/%3E%3C/svg%3E");
    }
    .nav-task .nav-icon {
      mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'/%3E%3C/svg%3E");
    }
    .nav-wallet .nav-icon {
      mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z'/%3E%3C/svg%3E");
    }
    .nav-label {
      font-size: 0.7em;
      font-weight: 500;
      color: #e0e0e0;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    #snackbar {
      display: none;
      position: fixed;
      top: 18px;
      left: 50%;
      transform: translateX(-50%);
      background: #059669;
      color: white;
      padding: 9px 20px;
      border-radius: 24px;
      z-index: 2001;
      font-weight: 600;
      font-size: 1em;
      box-shadow: 0 2px 12px #051d4036;
      transition: opacity 0.4s;
      opacity: 1;
    }
    #snackbar.error {
      background: #ef4444;
      box-shadow: 0 2px 12px rgba(239,68,68,0.4);
    }
    @media (max-width: 360px) {
      .container { width: 100%; padding: 7px 3px 90px 3px; }
      .bottom-nav { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-title" id="telegram-id">Loading User...</div>
    </div>

    <!-- Balance Display -->
    <div class="balance-display">
      <div class="balance-label">Current DOGS Balance:</div>
      <div class="balance-value" id="dogs-balance">...</div>
    </div>

    <!-- Daily Tasks Section -->
    <div class="tasks-section">
      <div class="section-title">Daily Tasks</div>
      <!-- Task 1: Daily Check-in -->
      <div class="task-item">
        <div class="task-info">
          <div class="task-title">Daily Check-in</div>
          <div class="task-reward">+ 10 DOGS</div>
        </div>
        <button class="task-btn earn-btn" id="task1-btn" onclick="startTask(1)">EARN</button>
      </div>
      
      <!-- Task 2: Invite -->
      <div class="task-item">
        <div class="task-info">
          <div class="task-title">Invite</div>
          <div class="task-reward">Invite friends</div>
          </div>
          <button class="task-btn earn-btn" id="task2-btn" onclick="openInvite()">INVITE</button>
          </div>

      <!-- Task 3: Share App -->
      <div class="task-item">
        <div class="task-info">
          <div class="task-title">Share App</div>
          <div class="task-reward">+ 10 DOGS</div>
        </div>
        <button class="task-btn earn-btn" id="task3-btn" onclick="shareApp()">EARN</button>
      </div>
      <!-- Task 4: Like Post -->
      <div class="task-item">
        <div class="task-info">
          <div class="task-title">Like Post</div>
          <div class="task-reward">+ 10 DOGS</div>
        </div>
        <button class="task-btn earn-btn" id="task4-btn" onclick="likePost()">EARN</button>
      </div>
    </div>

    <!-- Promo Code Section -->
    <div class="tasks-section">
      <div class="section-title">PROMO CODE</div>
      <div class="promo-input-container">
        <input type="text" 
               id="promo-code-input" 
               class="promo-input" 
               placeholder="Enter promo code" 
               maxlength="20"/>
        <button id="promo-code-btn" 
                class="promo-btn"
                onclick="redeemPromoCode()">
          REDEEM
        </button>
      </div>
    </div>

    <!-- Firebase Tasks Section -->
    <div class="tasks-section">
      <div class="section-header">
        <div class="section-title">Tasks</div>
        <button class="create-btn" onclick="window.location.href='create.html'">CREATE</button>
      </div>
      <div id="firebase-tasks-container">
        <!-- Dynamic tasks will be loaded here -->
      </div>
    </div>
  </div>

  <div id="snackbar"></div>

  <div class="bottom-nav">
    <div class="nav-item nav-home" onclick="window.location.href='index.html'">
      <div class="nav-icon"></div>
      <span class="nav-label">Home</span>
    </div>
    <div class="nav-item nav-ads" onclick="window.location.href='ads.html'">
      <div class="nav-icon"></div>
      <span class="nav-label">Ads</span>
    </div>
    <div class="nav-item nav-task active" onclick="window.location.href='tasks.html'">
      <div class="nav-icon"></div>
      <span class="nav-label">Tasks</span>
    </div>
    <div class="nav-item nav-wallet" onclick="window.location.href='wallet.html'">
      <div class="nav-icon"></div>
      <span class="nav-label">Wallet</span>
    </div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getDatabase, ref, get, set, update, remove, runTransaction } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

  // Snackbar
  function showSnackbar(msg, isError = false) {
    const bar = document.getElementById('snackbar');
    if (!bar) return;
    bar.textContent = msg;
    bar.className = isError ? 'error' : '';
    bar.style.display = 'block';
    bar.style.opacity = 1;
    setTimeout(() => { 
      bar.style.opacity = 0; 
      setTimeout(() => { bar.style.display = 'none'; }, 400); 
    }, isError ? 4000 : 3000);
  }

  // Firebase init
  const firebaseConfig = {
    apiKey: "AIzaSyDznXZYyJDmYmfWhjb3BwHa8bnu48Z0Ra4",
    authDomain: "panda-combat.firebaseapp.com",
    databaseURL: "https://panda-combat-default-rtdb.firebaseio.com",
    projectId: "panda-combat",
    storageBucket: "panda-combat.firebasestorage.app",
    messagingSenderId: "257385009837",
    appId: "1:257385009837:web:12429aa7bd48fe22baac24",
    measurementId: "G-FJB3CP1S5F"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  // Telegram WebApp
  window.Telegram?.WebApp?.ready?.();
  const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
  const userKey = tgUser ? String(tgUser.id) : "7206619137";
  const userDisplayName = tgUser ? (tgUser.username ? "@"+tgUser.username : "ID: "+tgUser.id) : "7206619137";
  document.getElementById("telegram-id").textContent = userDisplayName;

  // Utilities
  function getTodayDate() { 
    return new Date().toISOString().split('T')[0]; 
  }

  function openInvite() { 
    window.location.href = 'invite.html'; 
  }
  window.openInvite = openInvite;

  // Check if link is a public Telegram channel (not bot, not private, not other platforms)
  function isPublicTelegramChannel(link) {
    if (!link) return false;
    try {
      const u = new URL(String(link).trim());
      const host = u.hostname.toLowerCase().replace(/^www\./, '');
      
      // Only t.me is allowed
      if (host !== 't.me') return false;
      
      const path = u.pathname.replace(/^\/+|\/+$/g, '');
      const segs = path ? path.split('/') : [];
      const first = (segs[0] || '').trim();
      if (!first) return false;

      // Reject private/invite link formats
      if (first.startsWith('+')) return false;          // t.me/+<hash>
      if (/^joinchat$/i.test(first)) return false;      // t.me/joinchat/<hash>
      if (/^c$/i.test(first)) return false;             // t.me/c/<id>/...

      // Reject bot deep links by query params
      const qs = new URLSearchParams(u.search);
      if (qs.has('start') || qs.has('startapp') || qs.has('startgroup') || qs.has('startchannel')) {
        return false;
      }

      // Heuristic: reject handles that look like bots
      const handleLow = first.toLowerCase();
      if (handleLow.endsWith('bot') || handleLow.includes('_bot')) return false;

      // Passed all checks -> public channel
      return true;
    } catch {
      return false;
    }
  }

  // Extract @username from public t.me channel links only
  function getTelegramHandleFromTMe(link) {
    if (!link) return null;
    try {
      const u = new URL(String(link).trim());
      const host = u.hostname.toLowerCase().replace(/^www\./, '');
      if (host !== 't.me') return null;
      
      const path = u.pathname.replace(/^\/+|\/+$/g, '');
      const segs = path ? path.split('/') : [];
      const first = (segs[0] || '').trim();
      if (!first) return null;
      
      // Skip private formats
      if (first.startsWith('+')) return null;
      if (/^joinchat$/i.test(first)) return null;
      if (/^c$/i.test(first)) return null;
      
      return '@' + first;
    } catch {
      return null;
    }
  }

  // Daily task field mappings
  const taskFields = {
    1: 'lastClaimedDailyCheckInDate',
    3: 'lastClaimedShareAppDate',
    4: 'lastClaimedLikePostDate'
  };

  let currentDogsBalance = 0;

  // Atomic totals increment
  async function incrementTotals(amount, currency = 'DOGS', doneInc = 1) {
    const totalEarnRef   = ref(db, `users/${userKey}/totalEarn`);
    const byCurrencyRef  = ref(db, `users/${userKey}/totalEarnBy/${currency}`);
    const taskDoneRef    = ref(db, `users/${userKey}/taskDone`);
    
    await Promise.all([
      runTransaction(totalEarnRef,  cur => (cur ?? 0) + Number(amount)),
      runTransaction(byCurrencyRef, cur => (cur ?? 0) + Number(amount)),
      runTransaction(taskDoneRef,   cur => (cur ?? 0) + Number(doneInc)),
    ]);
  }

  // Load user data and button states
  async function loadUserData() {
    const userRef = ref(db, 'users/' + userKey);
    try {
      const snap = await get(userRef);
      let data;
      
      if (snap.exists()) {
        data = snap.val() || {};
      } else {
        await set(userRef, { dogs: 10, usdt: 0.00, ton: 0.00 });
        data = { dogs: 10, usdt: 0, ton: 0 };
      }
      
      currentDogsBalance = data.dogs ?? 0;
      document.getElementById('dogs-balance').textContent = String(currentDogsBalance);

      // Update daily task buttons
      [1, 3, 4].forEach(n => {
        const btn = document.getElementById(`task${n}-btn`);
        if (!btn) return;
        
        const last = data[taskFields[n]];
        if (last === getTodayDate()) {
          btn.className = 'task-btn claimed-btn';
          btn.textContent = 'CLAIMED';
          btn.disabled = true;
          btn.onclick = null;
        } else {
          btn.className = 'task-btn earn-btn';
          btn.textContent = 'EARN';
          btn.disabled = false;
          if (n === 1) btn.onclick = () => startTask(1);
          if (n === 3) btn.onclick = () => shareApp();
          if (n === 4) btn.onclick = () => likePost();
        }
      });
    } catch (e) {
      document.getElementById('dogs-balance').textContent = 'ERR';
      console.error('loadUserData error:', e);
    }
  }

  // Load Firebase dynamic tasks - SABHI TASKS DISPLAY (no filtering)
  async function loadFirebaseTasks() {
    try {
      const tasksRef = ref(db, 'tasks');
      const snap = await get(tasksRef);
      const container = document.getElementById('firebase-tasks-container');
      if (!container) return;

      if (!snap.exists() || !snap.val()) {
        container.innerHTML = '<div class="no-tasks">NOT CREATED TASKS</div>';
        return;
      }

      const tasks = snap.val();
      const userSnap = await get(ref(db, 'users/' + userKey));
      const userData = userSnap.val() || {};
      container.innerHTML = '';

      // Filter: active, not full, not done today - ALL TASKS LOAD
      const active = Object.entries(tasks).filter(([taskId, task]) => {
        const currentCompletions = task.currentCompletions || 0;
        const maxCompletions     = task.maxCompletions || 0;
        const status             = task.status;
        const doneToday          = userData[`completedTask_${taskId}`] === getTodayDate();
        
        return status === 'active' 
          && currentCompletions < maxCompletions 
          && !doneToday;
      });

      if (active.length === 0) {
        container.innerHTML = '<div class="no-tasks">NOT CREATED TASKS</div>';
        return;
      }

      active.forEach(([taskId, task]) => {
        const el = document.createElement('div');
        el.className = 'task-item';
        el.innerHTML = `
          <div class="task-info">
            <div class="task-title">${task.title || 'Task'}</div>
            <div class="task-reward">+ ${task.reward || 10} DOGS</div>
          </div>
          <button class="task-btn join-btn" id="firebase-task-${taskId}">JOIN</button>
        `;
        container.appendChild(el);
        
        const btn = document.getElementById(`firebase-task-${taskId}`);
        if (btn) btn.onclick = () => startFirebaseTask(taskId, task);
      });
    } catch (e) {
      console.error('loadFirebaseTasks error:', e);
      const container = document.getElementById('firebase-tasks-container');
      if (container) container.innerHTML = '<div class="no-tasks">ERROR LOADING TASKS</div>';
    }
  }

  // Daily tasks: start countdown
  function startTask(n) {
    const btn = document.getElementById(`task${n}-btn`);
    if (!btn) return;
    
    let t = 6;
    btn.className = 'task-btn countdown-btn';
    btn.disabled = true;
    
    const iv = setInterval(() => {
      btn.textContent = t + 's';
      t--;
      if (t < 0) {
        clearInterval(iv);
        btn.className = 'task-btn claim-btn';
        btn.textContent = 'CLAIM';
        btn.disabled = false;
        btn.onclick = () => claimTask(n);
      }
    }, 1000);
  }

  // Daily tasks: claim reward
  async function claimTask(n) {
    const btn = document.getElementById(`task${n}-btn`);
    if (!btn) return;
    
    const reward = 10;
    try {
      const userRef = ref(db, 'users/' + userKey);
      const snap = await get(userRef);
      const data = snap.val() || {};
      const flag = taskFields[n];

      if (data[flag] === getTodayDate()) {
        showSnackbar('Already claimed today!', true);
        btn.className = 'task-btn claimed-btn';
        btn.textContent = 'CLAIMED';
        btn.disabled = true;
        btn.onclick = null;
        return;
      }

      const newDogs = (data.dogs ?? 0) + reward;
      await update(userRef, { dogs: newDogs, [flag]: getTodayDate() });
      await incrementTotals(reward, 'DOGS', 1);

      currentDogsBalance = newDogs;
      document.getElementById('dogs-balance').textContent = String(newDogs);

      btn.className = 'task-btn claimed-btn';
      btn.textContent = 'CLAIMED';
      btn.disabled = true;
      btn.onclick = null;

      showSnackbar(`🎉 You got ${reward} DOGS`);
    } catch (e) {
      console.error('claimTask error:', e);
      showSnackbar('Error claiming reward!', true);
    }
  }

  // Firebase task: JOIN -> write check ONLY for public Telegram channels
  function startFirebaseTask(taskId, task) {
    const btn = document.getElementById(`firebase-task-${taskId}`);
    if (!btn) return;

    // CONDITIONAL CHECK WRITE: sirf public Telegram channel ke liye
    const isPublic = isPublicTelegramChannel(task.link);
    
    if (isPublic) {
      const unameKey = getTelegramHandleFromTMe(task.link);
      const checkKey = unameKey || taskId;
      
      update(ref(db, `users/${userKey}/check/${checkKey}`), {
        stutes: 'checking',
        updatedAt: new Date().toISOString()
      }).catch(err => console.warn('check write failed:', err));
    }

    // Open link (works for all tasks)
    if (task.link) window.open(task.link, '_blank');

    // Countdown (works for all tasks)
    let t = 8;
    btn.className = 'task-btn countdown-btn';
    btn.disabled = true;
    
    const iv = setInterval(() => {
      btn.textContent = t + 's';
      t--;
      if (t < 0) {
        clearInterval(iv);
        btn.className = 'task-btn claim-btn';
        btn.textContent = 'CLAIM';
        btn.disabled = false;
        btn.onclick = () => claimFirebaseTask(taskId, task);
      }
    }, 1000);
  }

  // Firebase task: CLAIM reward
  // Public channel: check block read + st=='done' required
  // Other links: NO check block read, direct reward claim
  async function claimFirebaseTask(taskId, task) {
    const btn = document.getElementById(`firebase-task-${taskId}`);
    if (!btn) return;

    try {
      const userRef = ref(db, 'users/' + userKey);
      const taskRef = ref(db, 'tasks/' + taskId);

      const isPublic = isPublicTelegramChannel(task.link);

      let uSnap, tSnap;
      let checkRefToDelete = null;

      if (isPublic) {
        // PUBLIC TELEGRAM CHANNEL: read check block and require st == 'done'
        const unameKey = getTelegramHandleFromTMe(task.link);
        const userCheckURef = unameKey ? ref(db, `users/${userKey}/check/${unameKey}`) : null;
        const userCheckTRef = ref(db, `users/${userKey}/check/${taskId}`);

        const [uS, tS, chkUSnap, chkTSnap] = await Promise.all([
          get(userRef),
          get(taskRef),
          unameKey ? get(userCheckURef) : Promise.resolve(null),
          get(userCheckTRef)
        ]);

        uSnap = uS;
        tSnap = tS;

        const checkSnap = (chkUSnap && chkUSnap.exists()) ? chkUSnap : chkTSnap;
        checkRefToDelete = (chkUSnap && chkUSnap.exists()) ? userCheckURef : userCheckTRef;
        const checkData = checkSnap?.val() || {};
        const st = String(checkData.stutes || '').toLowerCase();

        if (st !== 'done') {
          showSnackbar('❌ Please complete task', true);
          return;
        }
      } else {
        // NON-PUBLIC LINKS: DO NOT read check block, allow direct claim
        [uSnap, tSnap] = await Promise.all([
          get(userRef),
          get(taskRef)
        ]);
      }

      const uData = uSnap.val() || {};
      const tData = tSnap.val() || {};

      const completedField = `completedTask_${taskId}`;
      if (uData[completedField] === getTodayDate()) {
        showSnackbar('Already claimed today!', true);
        btn.className = 'task-btn claimed-btn';
        btn.textContent = 'CLAIMED';
        btn.disabled = true;
        btn.onclick = null;
        return;
      }

      const current = tData.currentCompletions || 0;
      const max     = tData.maxCompletions || 0;
      if (current >= max) {
        showSnackbar('Task completed by maximum users!', true);
        btn.className = 'task-btn claimed-btn';
        btn.textContent = 'FULL';
        btn.disabled = true;
        btn.onclick = null;
        return;
      }

      const reward  = task.reward || 10;
      const newDogs = (uData.dogs ?? 0) + reward;

      await update(userRef, { dogs: newDogs, [completedField]: getTodayDate() });
      await incrementTotals(reward, 'DOGS', 1);

      const next = current + 1;
      const updatedBy = [...(tData.completedBy || []), userKey];
      const taskUpdates = { currentCompletions: next, completedBy: updatedBy };
      if (next >= max) taskUpdates.status = 'completed';
      await update(taskRef, taskUpdates);

      // Delete check node if it was used
      if (checkRefToDelete) await remove(checkRefToDelete);

      currentDogsBalance = newDogs;
      document.getElementById('dogs-balance').textContent = String(newDogs);
      
      btn.className = 'task-btn claimed-btn';
      btn.textContent = 'CLAIMED';
      btn.disabled = true;
      btn.onclick = null;
      
      showSnackbar(`🎉 You got ${reward} DOGS`);
      setTimeout(() => { loadFirebaseTasks(); }, 800);
    } catch (e) {
      console.error('claimFirebaseTask error:', e);
      showSnackbar('Error claiming reward!', true);
    }
  }

  // Share App task
  function shareApp() {
    const msg = `Earn DOGS AND USDT for free

https://t.me/ByteMintBot?start=${userKey}

✅ invite your friends and earn USDT/DOGS
✅ 1000% free
✅ No deposit 
✅ earn upto 100$ and 1000k DOGS daily`;
    const url = `https://t.me/share/url?url=${encodeURIComponent(msg)}`;
    window.open(url, '_blank');
    setTimeout(() => { claimTask(3); }, 600);
  }

  // Like Post task
  function likePost() {
    window.open("https://t.me/ByteMint_community", "_blank");
    setTimeout(() => { claimTask(4); }, 600);
  }

  // Promo Code redemption
  window.redeemPromoCode = async function() {
    const promoInput = document.getElementById("promo-code-input");
    const promoBtn   = document.getElementById("promo-code-btn");
    if (!promoInput || !promoBtn) return;
    
    const promoCode = promoInput.value.trim().toUpperCase();
    if (!promoCode) {
      showSnackbar("Please enter a promo code", true);
      return;
    }
    
    promoBtn.disabled = true;
    promoBtn.textContent = 'CHECKING...';

    try {
      const promoRef = ref(db, 'promoCodes/' + promoCode);
      const promoSnap = await get(promoRef);
      
      if (!promoSnap.exists()) {
        showSnackbar("Invalid promo code", true);
        return;
      }
      
      const promo = promoSnap.val() || {};
      if (!promo.active) {
        showSnackbar("Promo code has expired", true);
        return;
      }
      
      const usedCount = promo.usedCount || 0;
      const maxUses = promo.maxUses || 1000;
      if (usedCount >= maxUses) {
        showSnackbar("Promo code usage limit reached", true);
        return;
      }

      const userRef = ref(db, 'users/' + userKey);
      const userSnap = await get(userRef);
      const userData = userSnap.val() || {};
      
      const usedPromosField = 'usedPromoCodes';
      const usedPromos = userData[usedPromosField] || [];
      if (usedPromos.includes(promoCode)) {
        showSnackbar("You have already used this promo code", true);
        return;
      }
      
      if (promo.expiryDate && new Date() > new Date(promo.expiryDate)) {
        showSnackbar("Promo code has expired", true);
        return;
      }

      const rewardAmount   = Number(promo.rewardAmount || 100);
      const rewardCurrency = (promo.rewardCurrency || 'DOGS').toUpperCase();

      let newData = {
        dogs: userData.dogs || 0,
        usdt: userData.usdt || 0,
        ton:  userData.ton  || 0
      };
      
      if (rewardCurrency === 'DOGS') newData.dogs += rewardAmount;
      else if (rewardCurrency === 'USDT') newData.usdt += rewardAmount;
      else if (rewardCurrency === 'TON') newData.ton += rewardAmount;

      const updatedUsedPromos = [...usedPromos, promoCode];
      await update(userRef, { ...newData, [usedPromosField]: updatedUsedPromos });
      await incrementTotals(rewardAmount, rewardCurrency, 1);

      currentDogsBalance = newData.dogs;
      document.getElementById('dogs-balance').textContent = String(newData.dogs);
      promoInput.value = '';
      
      showSnackbar(`🎉 Promo code redeemed! +${rewardAmount} ${rewardCurrency}`);

      await update(promoRef, { 
        usedCount: usedCount + 1, 
        lastUsed: new Date().toISOString() 
      });
    } catch (e) {
      console.error('redeemPromoCode error:', e);
      showSnackbar('Error processing promo code', true);
    } finally {
      promoBtn.disabled = false;
      promoBtn.textContent = 'REDEEM';
    }
  };

  // Expose functions to global scope
  window.startTask = startTask;
  window.claimTask = claimTask;
  window.shareApp  = shareApp;
  window.likePost  = likePost;
  window.startFirebaseTask = startFirebaseTask;
  window.claimFirebaseTask = claimFirebaseTask;

  // Initialize
  async function init() {
    try {
      await loadUserData();
      await loadFirebaseTasks();
    } catch (e) {
      console.error('Init failed:', e);
      showSnackbar('Init failed. Check connection.', true);
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
</script>
</body>
</html>
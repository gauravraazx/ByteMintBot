<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <title>Invite - Earn DOGS</title>
  <meta name="viewport" content="width=340, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      color: #ffffff;
      font-family: 'Inter', Arial, sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
      font-size: 13px;
    }
    .container { width: 340px; margin: 0 auto; padding: 12px 8px 90px 8px; }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 14px; padding: 14px; text-align: center; margin-bottom: 14px;
      box-shadow: 0 8px 32px rgba(102,126,234,0.3); border: 1px solid rgba(255,255,255,0.1);
      position: relative;
    }
    .back-btn {
      position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
      background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
      color: white; width: 32px; height: 32px; border-radius: 8px; cursor: pointer;
      display: flex; align-items: center; justify-content: center; transition: all 0.3s; font-size: 16px;
    }
    .back-btn:hover { background: rgba(255,255,255,0.2); transform: translateY(-50%) translateX(-2px); }
    .header-title { font-size: 1.1em; font-weight: 700; letter-spacing: 1px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    .header-subtitle { font-size: 0.85em; font-weight: 500; margin-top: 4px; opacity: 0.9; }

    .invite-section {
      background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border-radius: 14px;
      padding: 16px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      margin-bottom: 16px;
    }
    .section-title { font-size: 0.95em; font-weight: 600; margin-bottom: 12px; color: #f0f0f0; text-transform: uppercase; letter-spacing: 1px; }

    .refer-link-container { background: rgba(255,255,255,0.03); border-radius: 10px; padding: 12px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 12px; }
    .refer-link-label { font-size: 0.8em; color: #9ca3af; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
    .refer-link-box { display: flex; gap: 8px; align-items: center; }
    .refer-link-input {
      flex: 1; padding: 10px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.05); color: #fff; font-size: 0.85em; outline: none; font-family: 'Inter', monospace;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .refer-link-input:focus { border-color: #8b5cf6; background: rgba(255,255,255,0.1); box-shadow: 0 0 0 2px rgba(139,92,246,0.2); }
    .copy-btn {
      padding: 10px 16px; border-radius: 8px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      border: none; color: white; font-weight: 600; cursor: pointer; text-transform: uppercase;
      box-shadow: 0 2px 8px rgba(139,92,246,0.3); transition: all 0.3s; font-size: 0.85em; letter-spacing: 0.5px; min-width: 60px;
    }
    .copy-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(139,92,246,0.4); }

    .share-btn {
      width: 100%; padding: 12px 16px; border-radius: 10px; background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border: none; color: white; font-weight: 600; cursor: pointer; text-transform: uppercase;
      box-shadow: 0 4px 16px rgba(16,185,129,0.3); transition: all 0.3s; font-size: 0.9em; letter-spacing: 1px;
      display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 12px;
    }
    .share-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(16,185,129,0.4); }
    .share-icon { width: 16px; height: 16px; background: currentColor; mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z'/%3E%3C/svg%3E"); mask-size: contain; mask-repeat: no-repeat; mask-position: center; }

    .stats-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }
    .stats-box {
      background: rgba(255,255,255,0.03); border-radius: 10px; padding: 12px; border: 1px solid rgba(255,255,255,0.05);
      text-align: center; cursor: pointer; transition: all 0.3s;
    }
    .stats-box:hover { background: rgba(255,255,255,0.07); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    .stats-number { font-size: 1.2em; font-weight: 700; color: #4ade80; margin-bottom: 2px; }
    .stats-label { font-size: 0.8em; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; }

    .row-item { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9em; }
    .row-item:last-child { border-bottom: none; }
    .row-num { width: 24px; color: #9ca3af; }
    .row-text { color: #f0f0f0; font-weight: 500; flex: 1; margin-left: 10px; }
    .row-amount { color: #4ade80; font-weight: 600; margin-left: 10px; }

    .bottom-nav {
      position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
      width: 340px; background: rgba(0,0,0,0.9); backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px 20px 0 0; padding: 16px 12px; display: flex; justify-content: space-around; align-items: center; z-index: 100;
    }
    .nav-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 8px 8px; border-radius: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); min-width: 50px; flex: 1; margin: 0 2px; }
    .nav-item:hover { background: rgba(255,255,255,0.1); transform: translateY(-2px); }
    .nav-item.active { background: rgba(102,126,234,0.2); border-color: rgba(102,126,234,0.3); }
    .nav-icon { width: 22px; height: 22px; margin-bottom: 4px; background: #fff; mask-size: contain; mask-repeat: no-repeat; mask-position: center; }
    .nav-home .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m3 12 2-2m0 0 7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6'/%3E%3C/svg%3E"); }
    .nav-ads .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z'/%3E%3C/svg%3E"); }
    .nav-task .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'/%3E%3C/svg%3E"); }
    .nav-wallet .nav-icon { mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z'/%3E%3C/svg%3E"); }

    #snackbar {
      display: none; position: fixed; top: 18px; left: 50%; transform: translateX(-50%);
      background: #059669; color: white; padding: 9px 20px; border-radius: 24px; z-index: 2001; font-weight: 600; font-size: 1em;
      box-shadow: 0 2px 12px rgba(5,150,105,0.4); transition: opacity 0.4s; opacity: 1;
    }
    #snackbar.error { background: #ef4444; box-shadow: 0 2px 12px rgba(239,68,68,0.4); }

    /* Referral earnings row */
    .refer-earn-row {
      margin-top: 12px;
      display: flex;
      gap: 10px;
      align-items: center;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 10px 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    }
    .refer-earn-left { flex: 1; }
    .refer-earn-label { font-size: 0.8em; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; }
    .refer-earn-value { font-size: 1.05em; font-weight: 700; color: #4ade80; margin-top: 2px; }
    .refer-earn-claim-btn {
      padding: 10px 16px;
      border-radius: 10px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border: none;
      color: white;
      font-weight: 700;
      font-size: 0.9em;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 3px 12px rgba(16,185,129,0.35);
      min-width: 90px;
      transition: all 0.2s;
    }
    .refer-earn-claim-btn:disabled {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
      cursor: not-allowed;
      box-shadow: none;
    }

    @media (max-width: 360px) { .container { width: 100%; padding: 7px 3px 90px 3px; } .bottom-nav { width: 100%; } }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <button class="back-btn" onclick="window.location.href='tasks.html'">❮❮</button>
      <div class="header-title">INVITE FRIENDS</div>
      <div class="header-subtitle">Earn USDT & DOGS Together</div>
    </div>

    <!-- Referral link -->
    <div class="invite-section">
      <div class="section-title">Your Referral Link</div>
      <div class="refer-link-container">
        <div class="refer-link-label">Share this link with friends</div>
        <div class="refer-link-box">
          <input type="text" id="refer-link" class="refer-link-input" value="Loading..." readonly>
          <button class="copy-btn" onclick="copyReferLink()">COPY</button>
        </div>
      </div>

      <button class="share-btn" onclick="shareReferralLink()">
        <div class="share-icon"></div>
        SHARE WITH FRIENDS
      </button>

      <!-- New: Referral earnings row -->
      <div class="refer-earn-row">
        <div class="refer-earn-left">
          <div class="refer-earn-label">Referral Earnings</div>
          <div class="refer-earn-value" id="refer-earn-amount">0.00 DOGS</div>
        </div>
        <button class="refer-earn-claim-btn" id="refer-earn-claim-btn" onclick="claimReferEarn()">CLAIM</button>
      </div>

      <!-- Stats -->
      <div class="stats-container" style="margin-top: 12px;">
        <div class="stats-box">
          <div class="stats-number" id="total-referrals">0</div>
          <div class="stats-label">Total Refer</div>
        </div>
        <div class="stats-box">
          <div class="stats-number" id="earned-dogs">0 DOGS</div>
          <div class="stats-label">Total Earning (DOGS)</div>
        </div>
      </div>
    </div>

    <!-- Referral IDs List -->
    <div class="invite-section" id="referrals-box">
      <div class="section-title">Referral IDs</div>
      <div id="referral-ids"></div>
    </div>
  </div>

  <div id="snackbar"></div>

  <div class="bottom-nav">
    <div class="nav-item nav-home" onclick="window.location.href='index.html'">
      <div class="nav-icon"></div><span class="nav-label">Home</span>
    </div>
    <div class="nav-item nav-ads" onclick="window.location.href='ads.html'">
      <div class="nav-icon"></div><span class="nav-label">Ads</span>
    </div>
    <div class="nav-item nav-task" onclick="window.location.href='tasks.html'">
      <div class="nav-icon"></div><span class="nav-label">Tasks</span>
    </div>
    <div class="nav-item nav-wallet" onclick="window.location.href='wallet.html'">
      <div class="nav-icon"></div><span class="nav-label">Wallet</span>
    </div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script type="module">
  // Firebase v9 modular imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getDatabase, ref, get, update, runTransaction } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

  // Snackbar
  function showSnackbar(msg, isError = false) {
    const bar = document.getElementById('snackbar');
    if (!bar) return;
    bar.textContent = msg;
    bar.className = isError ? 'error' : '';
    bar.style.display = 'block';
    bar.style.opacity = 1;
    setTimeout(() => { bar.style.opacity = 0; setTimeout(() => { bar.style.display = 'none'; }, 400); }, isError ? 4000 : 3000);
  }

  // Firebase init
  const firebaseConfig = {
    apiKey: "AIzaSyDznXZYyJDmYmfWhjb3BwHa8bnu48Z0Ra4",
    authDomain: "panda-combat.firebaseapp.com",
    databaseURL: "https://panda-combat-default-rtdb.firebaseio.com",
    projectId: "panda-combat",
    storageBucket: "panda-combat.firebasestorage.app",
    messagingSenderId: "257385009837",
    appId: "1:257385009837:web:12429aa7bd48fe22baac24",
    measurementId: "G-FJB3CP1S5F"
  }; // RTDB setup per web docs
  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app); // Realtime Database handle
  // Telegram Mini App context
  window.Telegram?.WebApp?.ready?.(); // Hide loader when ready
  const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
  const userKey = tgUser ? String(tgUser.id) : "7206619137";

  // UI helpers
  const byId = (id) => document.getElementById(id);
  function generateReferralLink() {
    const baseUrl = "https://t.me/ByteMintBot";
    return `${baseUrl}?start=${userKey}`;
  }

  // Copy referral link
  window.copyReferLink = function () {
    const linkInput = byId('refer-link');
    if (!linkInput) return;
    try {
      linkInput.select();
      linkInput.setSelectionRange(0, 99999);
      document.execCommand('copy');
      showSnackbar('Referral link copied!');
    } catch {
      navigator.clipboard.writeText(linkInput.value)
        .then(() => showSnackbar('Referral link copied!'))
        .catch(() => showSnackbar('Failed to copy link', true));
    }
  };

  // Share referral link via Telegram share URL
  window.shareReferralLink = function () {
    const referralLink = generateReferralLink();
    const text = `Earn DOGS AND USDT for free

${referralLink}

✅ invite your friends and earn USDT/DOGS
✅ 1000% free
✅ No deposit
✅ earn upto 100$ and 1000k DOGS daily`;
    const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(referralLink)}&text=${encodeURIComponent(text)}`;
    if (window.Telegram?.WebApp?.openTelegramLink) {
      window.Telegram.WebApp.openTelegramLink(shareUrl);
    } else {
      window.open(shareUrl, '_blank');
    }
  };

  // Referral IDs extractor:
  // - If array: normalize items to strings
  // - If map like { "<referId>": true }: return keys (filter truthy values)
  function extractIds(raw) {
    if (Array.isArray(raw)) {
      return raw
        .filter(v => v != null && String(v).trim() !== '')
        .map(v => String(v));
    }
    if (raw && typeof raw === 'object') {
      const entries = Object.entries(raw);
      if (entries.length === 0) return [];
      const truthyKeys = entries.filter(([, val]) => Boolean(val)).map(([k]) => String(k));
      return truthyKeys.length ? truthyKeys : entries.map(([k]) => String(k));
    }
    return [];
  }

  // Load referral stats and list
  async function loadReferralStats() {
    try {
      const userRef = ref(db, `users/${userKey}`);
      const snap = await get(userRef);
      if (!snap.exists()) {
        byId('refer-link') && (byId('refer-link').value = generateReferralLink());
        byId('total-referrals') && (byId('total-referrals').textContent = '0');
        byId('earned-dogs') && (byId('earned-dogs').textContent = '0 DOGS');
        byId('referral-ids') && (byId('referral-ids').textContent = 'No referrals yet');
        return;
      }
      const data = snap.val() || {};
      byId('refer-link') && (byId('refer-link').value = generateReferralLink());

      const ids = Array.from(new Set(extractIds(data.totalRefer))); // map keys -> IDs
      const count = ids.length;
      const dogs = count * 50; // display logic only
      byId('total-referrals') && (byId('total-referrals').textContent = String(count));
      byId('earned-dogs') && (byId('earned-dogs').textContent = `${dogs} DOGS`);

      const listHost = byId('referral-ids');
      if (!listHost) return;
      listHost.textContent = '';
      if (count === 0) {
        listHost.textContent = 'No referrals yet';
        return;
      }
      ids.forEach((rid, idx) => {
        const row = document.createElement('div');
        row.className = 'row-item';
        row.innerHTML = `
          <div class="row-num">${idx + 1}.</div>
          <div class="row-text">${rid}</div>
          <div class="row-amount">+50 DOGS</div>
        `;
        listHost.append(row);
      });
    } catch (e) {
      byId('referral-ids') && (byId('referral-ids').textContent = 'Failed to load referrals');
    }
  }

  // Load referral earnings and button state
  async function loadReferEarn() {
    try {
      const userRef = ref(db, `users/${userKey}`);
      const snap = await get(userRef);
      const data = snap.exists() ? (snap.val() || {}) : {};
      const amount = Number(data.referEarn || 0);
      const valEl = byId('refer-earn-amount');
      const btnEl = byId('refer-earn-claim-btn');
      if (valEl) valEl.textContent = `${amount.toFixed(2)} DOGS`;
      if (btnEl) btnEl.disabled = amount <= 0;
    } catch (e) {
      // Optional: showSnackbar('Failed to load referral earnings', true);
    }
  }

  // CLAIM: Atomically transfer referEarn -> dogs, set referEarn to 0
  window.claimReferEarn = async function() {
    const btnEl = byId('refer-earn-claim-btn');
    if (btnEl) { btnEl.disabled = true; btnEl.textContent = 'CLAIMING...'; }
    try {
      const userRef = ref(db, `users/${userKey}`);
      const tx = await runTransaction(userRef, (current) => {
        const data = current || {};
        const earn = Number(data.referEarn || 0);
        if (!earn || earn <= 0) return current; // nothing to claim
        const dogs = Number(data.dogs || 0);
        return { ...data, dogs: dogs + earn, referEarn: 0 };
      }, { applyLocally: false });
      if (!tx.committed) {
        showSnackbar('Nothing to claim', true);
      } else {
        showSnackbar('Referral earnings claimed!');
      }
      await loadReferEarn(); // refresh earnings row
    } catch (e) {
      showSnackbar('Claim failed, try again', true);
    } finally {
      if (btnEl) { btnEl.disabled = false; btnEl.textContent = 'CLAIM'; }
    }
  };

  // Initialize page
  async function initInvitePage() {
    const hdr = document.querySelector('.header-title');
    if (hdr && tgUser) hdr.textContent = 'INVITE FRIENDS';
    const sub = document.querySelector('.header-subtitle');
    if (sub) sub.textContent = 'Earn USDT & DOGS Together';
    byId('refer-link') && (byId('refer-link').value = generateReferralLink());
    await loadReferralStats();
    await loadReferEarn();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initInvitePage);
  } else {
    initInvitePage();
  }
</script>

</body>
</html>

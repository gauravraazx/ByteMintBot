<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <title>Ads - Earn Points</title>
  <meta name="viewport" content="width=340, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%);color:#fff;font-family:'Inter',Arial,sans-serif;min-height:100vh;overflow-x:hidden;font-size:13px}
    .container{width:340px;margin:0 auto;padding:12px 8px 110px 8px}
    .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:14px;padding:14px;text-align:center;margin-bottom:14px;box-shadow:0 8px 32px rgba(102,126,234,.3);border:1px solid rgba(255,255,255,.1)}
    .header-title{font-size:1em;font-weight:700;letter-spacing:1px;text-shadow:0 2px 4px rgba(0,0,0,.3)}

    /* Earnings */
    .earnings-box{background:rgba(255,255,255,.05);backdrop-filter:blur(10px);border-radius:14px;padding:16px;margin-bottom:12px;border:1px solid rgba(255,255,255,.1);box-shadow:0 8px 32px rgba(0,0,0,.3)}
    .earnings-title{font-size:.95em;font-weight:600;margin-bottom:12px;color:#f0f0f0;text-transform:uppercase;letter-spacing:1px;text-align:center}
    .earning-item{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:rgba(255,255,255,.03);border-radius:8px;margin-bottom:8px;border:1px solid rgba(255,255,255,.05)}
    .earning-label{font-size:.9em;font-weight:500;color:#e0e0e0}
    .earning-value{font-size:.9em;font-weight:600}
    .balance-value{color:#4ade80}.total-earning-value{color:#f59e0b}.today-earning-value{color:#3b82f6}

    /* Inline convert inside earnings box */
    .convert-inline{margin-top:6px;padding-top:12px;border-top:1px solid rgba(255,255,255,.08)}
    .convert-title{font-size:.9em;font-weight:700;color:#e7ecff;margin-bottom:8px;letter-spacing:.2px}
    .convert-row{display:flex;gap:8px;align-items:center}
    .convert-input{flex:1;appearance:textfield;background:rgba(13,18,35,.55);border:1px solid rgba(255,255,255,.12);color:#e9eefb;border-radius:12px;padding:12px 12px;font-weight:700;outline:none}
    .convert-input::placeholder{color:#93a3bf}
    .convert-btn{white-space:nowrap;padding:12px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:linear-gradient(135deg,#06b6d4,#3b82f6);color:#fff;font-weight:800;cursor:pointer;box-shadow:0 8px 20px rgba(59,130,246,.35);transition:transform .15s ease}
    .convert-btn:active{transform:scale(.98)}
    .convert-btn:disabled{opacity:.6;cursor:not-allowed}
    .convert-meta{margin-top:6px;font-size:.8em;color:#cfd6e6}
    .convert-meta .ok{color:#34d399}
    .convert-meta .warn{color:#f59e0b}
    .convert-meta .err{color:#ef4444}

    /* Ads section (glass) */
    .ads-section{position:relative;padding:16px;border-radius:16px;background:rgba(255,255,255,.06);backdrop-filter:blur(14px) saturate(120%);-webkit-backdrop-filter:blur(14px) saturate(120%);border:1px solid rgba(255,255,255,.14);box-shadow:0 10px 30px rgba(0,0,0,.35),inset 0 1px 0 rgba(255,255,255,.06);margin-bottom:16px;overflow:hidden}
    .ads-section::before{content:"";position:absolute;inset:0;background:radial-gradient(120% 60% at -10% -20%,rgba(124,58,237,.28) 0%,transparent 60%),radial-gradient(120% 60% at 110% 120%,rgba(99,102,241,.22) 0%,transparent 60%);pointer-events:none}
    .section-title{display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:999px;background:linear-gradient(135deg,#67e8f9 0%,#a78bfa 50%,#f472b6 100%);color:#0b1020;font-weight:700;font-size:.9em;margin:0 auto 14px;text-transform:none;letter-spacing:.3px;box-shadow:0 6px 18px rgba(167,139,250,.35)}
    .section-title::before{content:"";width:16px;height:16px;background:#0b1020;mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%23000" d="M8 5v14l11-7z"/></svg>') center/contain no-repeat}

    .ad-item{position:relative;display:flex;flex-direction:column;gap:10px;padding:14px;border-radius:14px;background:rgba(13,18,35,.55);border:1px solid rgba(255,255,255,.08);box-shadow:0 8px 20px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease;text-align:left;margin-bottom:12px}
    .ad-item:hover{transform:translateY(-2px);box-shadow:0 12px 26px rgba(0,0,0,.45);border-color:rgba(255,255,255,.16)}
    .ad-title{font-size:1.02em;font-weight:700;letter-spacing:.2px;color:#f4f4f5;margin-bottom:2px}
    .ad-reward{display:inline-flex;align-items:center;gap:8px;width:max-content;margin-top:2px;padding:6px 10px;border-radius:10px;background:linear-gradient(135deg,rgba(16,185,129,.15),rgba(34,197,94,.15));color:#34d399;font-weight:600;border:1px solid rgba(16,185,129,.35)}
    .ad-reward::before{content:"";width:14px;height:14px;background:#34d399;mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path fill="%23000" d="M10 2a8 8 0 100 16 8 8 0 000-16zm1 4v2.09a3.5 3.5 0 012.5 3.36c0 1.93-1.57 3.5-3.5 3.5H9a1 1 0 110-2h1a1.5 1.5 0 000-3H9a1 1 0 110-2h2V6a1 1 0 112 0z"/></svg>') center/contain no-repeat}

    /* Progress rows */
    .progress-row{display:flex;flex-direction:column;gap:6px;margin-top:6px}
    .progress-row.subtle{opacity:.95}
    .progress-label{display:flex;justify-content:space-between;align-items:center;font-size:.85em;color:#cfd6e6}
    .progress-track{position:relative;height:10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);overflow:hidden}
    .progress-track.inverse{background:rgba(255,255,255,.04)}
    .progress-fill{height:100%;width:0%;background:linear-gradient(90deg,#22c55e 0%,#10b981 45%,#06b6d4 100%);transition:width .35s ease}
    .progress-fill.inverse{background:linear-gradient(90deg,#22c55e 0%,#84cc16 60%,#f59e0b 100%)}

    /* Buttons */
    .ad-btn{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background-clip:padding-box;font-weight:700;cursor:pointer;transition:transform .2s ease, box-shadow .2s ease, background .2s ease, opacity .2s ease}
    .ad-btn:disabled{opacity:.6;cursor:not-allowed}
    .watch-btn{background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:#fff;box-shadow:0 8px 20px rgba(124,58,237,.4)}
    .watch-btn::before{content:"";width:16px;height:16px;margin-right:8px;background:#fff;display:inline-block;vertical-align:-3px;mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%23000" d="M8 5v14l11-7z"/></svg>') center/contain no-repeat}
    .ad-processing-btn{background:linear-gradient(135deg,#60a5fa,#3b82f6);color:#fff;cursor:wait;position:relative;box-shadow:0 6px 16px rgba(59,130,246,.35)}
    .ad-processing-btn::after{content:"";width:16px;height:16px;margin-left:8px;display:inline-block;vertical-align:-3px;border-radius:50%;border:2px solid rgba(255,255,255,.7);border-top-color:transparent;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Bottom nav */
    .bottom-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:340px;background:rgba(0,0,0,.9);backdrop-filter:blur(20px);border-top:1px solid rgba(255,255,255,.1);border-radius:20px 20px 0 0;padding:16px 12px;display:flex;justify-content:space-around;align-items:center;z-index:100}
    .nav-item{display:flex;flex-direction:column;align-items:center;cursor:pointer;padding:8px 8px;border-radius:12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);min-width:50px;flex:1;margin:0 2px;transition:transform .2s ease, background .2s ease}
    .nav-item:hover{background:rgba(255,255,255,.1);transform:translateY(-2px)}
    .nav-item.active{background:rgba(102,126,234,.2);border-color:rgba(102,126,234,.3)}
    .nav-icon{width:22px;height:22px;margin-bottom:4px;background:#fff;mask-size:contain;mask-repeat:no-repeat;mask-position:center}
    .nav-home .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m3 12 2-2m0 0 7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6'/%3E%3C/svg%3E")}
    .nav-ads .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z'/%3E%3C/svg%3E")}
    .nav-task .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'/%3E%3C/svg%3E")}
    .nav-wallet .nav-icon{mask-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z'/%3E%3C/svg%3E")}
    .nav-label{font-size:.7em;font-weight:500;color:#e0e0e0;text-transform:uppercase;letter-spacing:.3px}

    /* Snackbar */
    #snackbar{display:none;position:fixed;top:18px;left:50%;transform:translateX(-50%);background:#059669;color:white;padding:12px 24px;border-radius:24px;z-index:2001;font-weight:600;font-size:1em;box-shadow:0 4px 16px rgba(5,150,105,.4);transition:opacity .4s;opacity:1;letter-spacing:.5px}
    #snackbar.error{background:#ef4444;box-shadow:0 4px 16px rgba(239,68,68,.4)}

    @media(max-width:360px){
      .container{width:100%;padding:7px 3px 110px 3px}
      .bottom-nav{width:100%}
      .ad-item{padding:12px}
      .ad-btn{padding:11px 12px}
      .convert-input{padding:11px 12px}
      .convert-btn{padding:11px 12px}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header"><div class="header-title" id="telegram-id">Loading User...</div></div>

    <div class="earnings-box">
      <div class="earnings-title">üìä Earnings Summary</div>
      <div class="earning-item">
        <div class="earning-label">üí∞ Balance (Points):</div>
        <div class="earning-value balance-value" id="balance-display">... Points</div>
      </div>
      <div class="earning-item">
        <div class="earning-label">üìà Total Earning (Points):</div>
        <div class="earning-value total-earning-value" id="total-earning">... Points</div>
      </div>
      <div class="earning-item">
        <div class="earning-label">‚≠ê Today Earning (Points):</div>
        <div class="earning-value today-earning-value" id="today-earning">... Points</div>
      </div>

      <!-- INLINE: Convert Points -> DOGS -->
      <div class="convert-inline">
        <div class="convert-title">Convert Points ‚Üí DOGS</div>
        <div class="convert-row">
          <input id="convert-amount" class="convert-input" type="number" min="1" step="1" placeholder="Enter Points to convert">
          <button id="convert-btn" class="convert-btn">Convert to DOGS</button>
        </div>
        <div class="convert-meta" id="convert-meta">
          Rate: 100 Points ‚Üí 75 DOGS ‚Ä¢ Minimum 1 Point ‚Ä¢ 25% fee implied
        </div>
      </div>
    </div>

    <div class="ads-section">
      <div class="section-title">üé¨ Watch Ads & Earn</div>

      <div class="ad-item">
        <div class="ad-title">üíé Premium Video Ad</div>
        <div class="ad-reward" id="reward-premium">+ 10 Points per ad</div>

        <div class="progress-row">
          <div class="progress-label"><span>View progress</span><span id="premium-view-text">0/25</span></div>
          <div class="progress-track" id="premium-view-track" role="progressbar" aria-label="Premium view progress" aria-valuemin="0" aria-valuemax="25" aria-valuenow="0">
            <div class="progress-fill" id="premium-view-bar"></div>
          </div>
        </div>

        <button class="ad-btn watch-btn" id="ad-button-premium">Watch Ad</button>
      </div>

      <div class="ad-item">
        <div class="ad-title">üöÄ Sponsored Content</div>
        <div class="ad-reward" id="reward-sponsored">+ 10 Points per view</div>

        <div class="progress-row">
          <div class="progress-label"><span>View progress</span><span id="sponsored-view-text">0/25</span></div>
          <div class="progress-track" id="sponsored-view-track" role="progressbar" aria-label="Sponsored view progress" aria-valuemin="0" aria-valuemax="25" aria-valuenow="0">
            <div class="progress-fill" id="sponsored-view-bar"></div>
          </div>
        </div>

        <button class="ad-btn watch-btn" id="ad-button-sponsored">Watch Ad</button>
      </div>
    </div>
  </div>

  <div id="snackbar"></div>

  <div class="bottom-nav">
    <div class="nav-item nav-home" onclick="window.location.href='index.html'"><div class="nav-icon"></div><span class="nav-label">Home</span></div>
    <div class="nav-item nav-ads active" onclick="window.location.href='ads.html'"><div class="nav-icon"></div><span class="nav-label">Ads</span></div>
    <div class="nav-item nav-task" onclick="window.location.href='tasks.html'"><div class="nav-icon"></div><span class="nav-label">Tasks</span></div>
    <div class="nav-item nav-wallet" onclick="window.location.href='wallet.html'"><div class="nav-icon"></div><span class="nav-label">Wallet</span></div>
  </div>

  <!-- Monetag SDK: ensure data-zone is MAIN ZONE and data-sdk matches function name -->
  <script src='//libtl.com/sdk.js' data-zone='9758754' data-sdk='show_9758754'></script>
  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- App Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    function showSnackbar(msg, isError = false) {
      const el = document.getElementById('snackbar');
      el.textContent = msg;
      el.className = isError ? 'error' : '';
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, isError ? 4000 : 2500);
    }

    // Wait for Monetag SDK global method
    async function waitForAdSdk(fnName, timeoutMs = 8000, intervalMs = 120) {
      const start = Date.now();
      return new Promise((resolve, reject) => {
        const tick = () => {
          const fn = window[fnName];
          if (typeof fn === 'function') return resolve(fn);
          if (Date.now() - start >= timeoutMs) return reject(new Error('SDK timeout'));
          setTimeout(tick, intervalMs);
        };
        tick();
      });
    }

    const firebaseConfig = {
      apiKey: "AIzaSyDznXZYyJDmYmfWhjb3BwHa8bnu48Z0Ra4",
      authDomain: "panda-combat.firebaseapp.com",
      databaseURL: "https://panda-combat-default-rtdb.firebaseio.com",
      projectId: "panda-combat",
      storageBucket: "panda-combat.firebasestorage.app",
      messagingSenderId: "257385009837",
      appId: "1:257385009837:web:12429aa7bd48fe22baac24"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // Telegram user
    window.Telegram?.WebApp?.ready?.();
    const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
    let userKey = tgUser?.id ? String(tgUser.id) : "UNKNOWN_USER";
    document.getElementById("telegram-id").textContent = tgUser?.username ? "@"+tgUser.username : userKey;

    // Config
    const MAX_ADS_PER_DAY = 25;
    const REWARD_POINTS   = 10;
    const AD_KEYS = { 'ad-button-premium':'premium', 'ad-button-sponsored':'sponsored' };

    // users/{id}: keep points & dogs here
    const DEFAULT_USER_DOC = { points: 0, dogs: 0 };

    const todayStr = () => new Date().toISOString().split('T')[0];
    let userData = null;

    async function ensureUserDoc() {
      const uref = ref(db, 'users/' + userKey);
      const snap = await get(uref);
      if (!snap.exists()) {
        await set(uref, DEFAULT_USER_DOC);
        return { ...DEFAULT_USER_DOC };
      }
      const val = snap.val() || {};
      const shaped = {
        points: Number(val.points || 0),
        dogs:   Number(val.dogs   || 0),
      };
      const backfill = {};
      if (typeof val.points !== 'number') backfill.points = shaped.points;
      if (typeof val.dogs   !== 'number') backfill.dogs   = shaped.dogs;
      if (Object.keys(backfill).length) await update(uref, backfill);
      return shaped;
    }

    async function getTodayViews() {
      const t = todayStr();
      const vref = ref(db, `adViews/${userKey}/${t}`);
      const vsnap = await get(vref);
      const val = vsnap.exists() ? (vsnap.val()||{}) : {};
      return {
        premium:   Number(val.premium||0),
        sponsored: Number(val.sponsored||0)
      };
    }

    function setBar(fillId, textId, now, max) {
      const pct = Math.max(0, Math.min(100, (now/max)*100));
      document.getElementById(fillId).style.width = `${pct}%`;
      document.getElementById(textId).textContent = `${now}/${max}`;
    }

    async function loadAndRender() {
      userData = await ensureUserDoc();
      const views = await getTodayViews();

      // reward labels
      document.getElementById('reward-premium').textContent   = `+ ${REWARD_POINTS} Points per ad`;
      document.getElementById('reward-sponsored').textContent = `+ ${REWARD_POINTS} Points per view`;

      const points = userData.points || 0;
      const pv = views.premium;
      const sv = views.sponsored;

      const todayEarnPoints = (pv + sv) * REWARD_POINTS;
      const totalPoints     = points;

      document.getElementById('balance-display').textContent = `${points} Points`;
      document.getElementById('total-earning').textContent  = `${totalPoints} Points`;
      document.getElementById('today-earning').textContent  = `${todayEarnPoints} Points`;

      setBar('premium-view-bar','premium-view-text', pv, MAX_ADS_PER_DAY);
      setBar('sponsored-view-bar','sponsored-view-text', sv, MAX_ADS_PER_DAY);

      document.getElementById('ad-button-premium').disabled   = pv>=MAX_ADS_PER_DAY;
      document.getElementById('ad-button-sponsored').disabled = sv>=MAX_ADS_PER_DAY;

      refreshConvertMetaPreview();
    }

    async function handleWatchAd(adButtonId, rewardPoints) {
      const adKey = AD_KEYS[adButtonId];
      const views = await getTodayViews();
      const prevCount = adKey === 'premium' ? views.premium : views.sponsored;
      if (prevCount >= MAX_ADS_PER_DAY) return showSnackbar("Daily limit reached", true);

      const btn = document.getElementById(adButtonId);
      btn.disabled = true; btn.className = "ad-btn ad-processing-btn"; btn.textContent = "Loading Ad...";

      try {
        // Ensure SDK function exists and is ready
        const fnName = 'show_9758754'; // must match data-sdk
        const showFn = await waitForAdSdk(fnName, 8000, 120);

        // Call with optional tracking params if supported
        let result;
        if (showFn.length > 0) {
          result = await showFn({
            ymid: String(userKey),       // helps correlate events/postbacks
            requestVar: adKey            // placement name: 'premium'/'sponsored'
          });
        } else {
          result = await showFn();
        }

        await claimAdReward(adKey, rewardPoints, prevCount);
      } catch (e) {
        console.error('Ad error:', e);
        showSnackbar("Ad failed or SDK unavailable", true);
      }

      await loadAndRender();
      btn.className = "ad-btn watch-btn"; btn.textContent = "Watch Ad"; btn.disabled = false;
    }

    async function claimAdReward(adKey, rewardPoints, prevCount) {
      const t = todayStr();
      const nextPoints = Number((userData?.points||0) + rewardPoints);
      const nextViews  = Number(prevCount + 1);

      await update(ref(db, 'users/' + userKey), { points: nextPoints });
      await update(ref(db, `adViews/${userKey}/${t}`), { [adKey]: nextViews });

      userData.points = nextPoints;
      showSnackbar(`üéâ Earned ${rewardPoints} Points!`);
    }

    // -------- Conversion: Points -> DOGS (75%) --------
    const amountEl = document.getElementById('convert-amount');
    const metaEl   = document.getElementById('convert-meta');
    const btnEl    = document.getElementById('convert-btn');

    function computeDogs(amount) {
      const n = Math.max(0, Math.floor(Number(amount||0)));
      return Math.floor(n * 0.75);
    }

    function refreshConvertMetaPreview() {
      const amt = Math.max(0, Math.floor(Number(amountEl.value||0)));
      if (!amt) {
        metaEl.innerHTML = 'Rate: 100 Points ‚Üí 75 DOGS ‚Ä¢ Minimum 1 Point ‚Ä¢ 25% fee implied';
        return;
      }
      const gets = computeDogs(amt);
      metaEl.innerHTML = `Converting ${amt} Points ‚Üí <span class="ok">${gets} DOGS</span> (75%)`;
    }

    amountEl?.addEventListener('input', refreshConvertMetaPreview);
    amountEl?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); btnEl.click(); } });

    async function handleConvert() {
      const raw = Number(amountEl.value);
      const amount = Math.floor(raw);

      if (!Number.isFinite(amount) || amount < 1) {
        return showSnackbar("Enter a valid amount (‚â• 1)", true);
      }

      btnEl.disabled = true; btnEl.textContent = "Converting...";

      try {
        const uref = ref(db, 'users/' + userKey);
        const snap = await get(uref);
        const val  = snap.exists() ? (snap.val()||{}) : { points:0, dogs:0 };
        const currentPoints = Number(val.points||0);
        const currentDogs   = Number(val.dogs||0);

        if (amount > currentPoints) {
          showSnackbar("Insufficient Points", true);
          return;
        }

        const dogsToAdd = computeDogs(amount);
        const nextPoints = currentPoints - amount;
        const nextDogs   = currentDogs + dogsToAdd;

        await update(uref, { points: nextPoints, dogs: nextDogs });

        if (userData) {
          userData.points = nextPoints;
          userData.dogs   = nextDogs;
        }

        amountEl.value = "";
        refreshConvertMetaPreview();
        document.getElementById('balance-display').textContent = `${nextPoints} Points`;
        document.getElementById('total-earning').textContent   = `${nextPoints} Points`;

        showSnackbar(`DOGS NEW BALANCE ${nextDogs}`);
      } catch (e) {
        showSnackbar("Conversion failed", true);
      } finally {
        btnEl.disabled = false; btnEl.textContent = "Convert to DOGS";
      }
    }

    btnEl?.addEventListener('click', handleConvert);

    document.addEventListener('DOMContentLoaded', async () => {
      await loadAndRender();
      document.getElementById('ad-button-premium').onclick   = () => handleWatchAd('ad-button-premium', REWARD_POINTS);
      document.getElementById('ad-button-sponsored').onclick = () => handleWatchAd('ad-button-sponsored', REWARD_POINTS);
    });
  </script>
</body>
</html>
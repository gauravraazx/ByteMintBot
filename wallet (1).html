<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <title>Wallet</title>
  <meta name="viewport" content="width=340, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
      font-family: 'Inter', Arial, sans-serif;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 13px;
      padding: 10px 5px 100px 5px;
    }
    .id-banner {
      width: 100%;
      max-width: 340px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      font-weight: 700;
      font-size: 1em;
      text-align: center;
      padding: 10px 10px;
      border-radius: 14px;
      margin-bottom: 16px;
      letter-spacing: 1px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
      box-shadow: 0 8px 32px rgba(102,126,234,0.3);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    /* Tab Buttons */
    .tab-buttons {
      width: 100%;
      max-width: 340px;
      display: flex;
      margin-bottom: 16px;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.1);
      overflow: hidden;
    }
    .tab-btn {
      flex: 1;
      padding: 12px 16px;
      background: transparent;
      color: rgba(255,255,255,0.7);
      border: none;
      font-family: inherit;
      font-size: 0.95em;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .tab-btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .tab-btn:hover:not(.active) {
      background: rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.9);
    }

    /* Content Containers */
    .content-container {
      width: 100%;
      max-width: 340px;
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(10px);
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.1);
      padding: 20px 15px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      display: none;
      flex-direction: column;
      gap: 16px;
    }
    .content-container.active {
      display: flex;
    }

    /* Deposit Styles */
    .deposit-section {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .deposit-item {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .deposit-label {
      font-weight: 600;
      font-size: 0.96em;
      letter-spacing: 0.5px;
      color: #f0f0f0;
      text-transform: uppercase;
    }
    .deposit-value-container {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 10px 12px;
      backdrop-filter: blur(8px);
    }
    .deposit-value {
      flex: 1;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 0.85em;
      color: #4ade80;
      font-weight: 500;
      word-break: break-all;
      line-height: 1.3;
    }
    .copy-btn {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border: none;
      border-radius: 6px;
      color: #fff;
      padding: 6px 10px;
      font-size: 0.8em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .copy-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 12px rgba(16,185,129,0.3);
    }
    .copy-btn:active {
      transform: translateY(0);
    }
    .note-text {
      background: rgba(255,193,7,0.1);
      border: 1px solid rgba(255,193,7,0.3);
      border-radius: 8px;
      padding: 12px;
      font-size: 0.85em;
      color: #ffd700;
      line-height: 1.4;
    }
    .note-text strong {
      color: #fff;
    }

    /* Withdraw Form Styles */
    .withdraw-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .form-group { 
      display: flex; 
      flex-direction: column; 
      gap: 5px; 
    }
    .form-label {
      font-weight: 600;
      font-size: 0.96em;
      letter-spacing: 0.5px;
      color: #f0f0f0;
      text-transform: uppercase;
      margin-bottom: 2px;
    }
    .form-input, .form-select {
      width: 100%;
      padding: 7px 10px;
      border-radius: 7px;
      font-family: inherit;
      font-size: 0.98em;
      font-weight: 500;
      outline: none;
      border: 2px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.1);
      color: #fff;
      backdrop-filter: blur(8px);
      transition: all 0.3s;
    }
    .form-input::placeholder, .form-select option {
      color: rgba(255,255,255,0.6);
    }
    .form-select option {
      background: #1a1a2e;
      color: #fff;
    }
    .form-input:focus, .form-select:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.2);
      background: rgba(255,255,255,0.15);
    }
    .form-input:disabled {
      background: rgba(255,255,255,0.05);
      color: rgba(255,255,255,0.5);
      cursor: not-allowed;
    }
    .hint-text {
      font-size: 0.80em;
      color: #4ade80;
      font-weight: 500;
      letter-spacing: 0.3px;
      margin-top: -3px;
    }
    .submit-btn {
      width: 100%;
      padding: 10px 5px;
      font-size: 1em;
      font-weight: 700;
      color: #fff;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border: none;
      border-radius: 8px;
      margin-top: 2px;
      letter-spacing: 0.7px;
      cursor: pointer;
      text-transform: uppercase;
      transition: all 0.3s;
      box-shadow: 0 3px 10px rgba(16,185,129,0.2);
    }
    .submit-btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 5px 18px rgba(16,185,129,0.3);
    }
    .submit-btn:disabled {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
      cursor: not-allowed;
      box-shadow: none;
    }
    .form-select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='white'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m19 9-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 18px;
      padding-right: 38px;
    }

    /* Withdrawal History Styles */
    .history-section {
      margin-top: 20px;
      width: 100%;
    }
    .history-header-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .history-title {
      font-size: 1.1em;
      font-weight: 700;
      color: #f0f0f0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .reload-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 6px;
      color: #fff;
      padding: 6px 10px;
      font-size: 1.1em;
      cursor: pointer;
      transition: all 0.3s;
      min-width: 32px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .reload-btn:hover {
      transform: translateY(-1px) rotate(180deg);
      box-shadow: 0 3px 12px rgba(102,126,234,0.3);
    }
    .reload-btn:active {
      transform: translateY(0);
    }
    .history-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .history-item {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 12px 14px;
      backdrop-filter: blur(8px);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .history-address {
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 0.85em;
      color: #f0f0f0;
      font-weight: 600;
    }
    .history-date {
      font-size: 0.75em;
      color: rgba(255,255,255,0.6);
      font-weight: 500;
    }
    .history-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .history-amount {
      font-size: 0.9em;
      color: #f0f0f0;
      font-weight: 600;
    }
    .status-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75em;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      border: 1px solid;
    }
    .status-pending {
      background: rgba(255,193,7,0.1);
      border-color: rgba(255,193,7,0.3);
      color: #ffc107;
    }
    .status-paid {
      background: rgba(34,197,94,0.1);
      border-color: rgba(34,197,94,0.3);
      color: #22c55e;
    }
    .status-rejected {
      background: rgba(239,68,68,0.1);
      border-color: rgba(239,68,68,0.3);
      color: #ef4444;
    }
    .no-history {
      text-align: center;
      color: rgba(255,255,255,0.5);
      font-size: 0.9em;
      padding: 20px;
      font-style: italic;
    }

    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 340px;
      background: rgba(0,0,0,0.9);
      backdrop-filter: blur(20px);
      border-top: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px 20px 0 0;
      padding: 16px 12px;
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 100;
    }
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      padding: 8px 8px;
      border-radius: 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      min-width: 50px;
      flex: 1;
      margin: 0 2px;
    }
    .nav-item:hover {
      background: rgba(255,255,255,0.1);
      transform: translateY(-2px);
    }
    .nav-item.active {
      background: rgba(102,126,234,0.2);
      border-color: rgba(102,126,234,0.3);
    }
    .nav-icon {
      width: 22px; height: 22px; margin-bottom: 4px;
      background: #fff;
      mask-size: contain;
      mask-repeat: no-repeat;
      mask-position: center;
    }
    .nav-home .nav-icon {
      mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m3 12 2-2m0 0 7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6'/%3E%3C/svg%3E");
    }
    .nav-ads .nav-icon {
      mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z'/%3E%3C/svg%3E");
    }
    .nav-task .nav-icon {
      mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'/%3E%3C/svg%3E");
    }
    .nav-wallet .nav-icon {
      mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z'/%3E%3C/svg%3E");
    }
    .nav-label {
      font-size: 0.7em;
      font-weight: 500;
      color: #e0e0e0;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    @media (max-width: 360px) {
      .id-banner { font-size: 0.87em; padding: 7px 6px; }
      .content-container { padding: 15px 10px; }
      .bottom-nav { width: 100%; }
    }
  </style>
</head>
<body>
  <!-- User Banner -->
  <div class="id-banner" id="id-banner">Loading User...</div>
  
  <!-- Tab Buttons -->
  <div class="tab-buttons">
    <button class="tab-btn active" id="depositTab" onclick="switchTab('deposit')">DEPOSIT <small><sup>+200%</sup></small></button>
    <button class="tab-btn" id="withdrawTab" onclick="switchTab('withdraw')">WITHDRAW</button>
  </div>

  <!-- Deposit Content -->
  <div class="content-container active" id="depositContent">
    <div class="deposit-section">
      <div class="deposit-item">
        <div class="deposit-label">Select Network</div>
        <select id="networkSelect" class="form-select" onchange="updateDepositNetwork()" required>
          <option value="">Select Network</option>
          <option value="TON" selected>TON (TON Open Network)</option>
          <option value="BEP20">BEP20 (BSC)</option>
        </select>
      </div>
      
      <div class="deposit-item" id="coinSelectContainer">
        <div class="deposit-label">Select Coin</div>
        <select id="depositCoinSelect" class="form-select" onchange="updateDepositInfo()" required>
          <option value="">Select Coin</option>
          <option value="DOGS">DOGS</option>
          <option value="TON">TON</option>
          <option value="USDT">USDT</option>
        </select>
      </div>
      
      <div class="deposit-item" id="addressContainer">
        <div class="deposit-label">Deposit Address:</div>
        <div class="deposit-value-container">
          <div class="deposit-value" id="depositAddress">UQCw_J1kMKQ4ikFKunOwdfgV89ZfC7pscMV3MgLhjbGdjQA7</div>
          <button class="copy-btn" onclick="copyToClipboard('depositAddress')">Copy</button>
        </div>
      </div>
      
      <div class="deposit-item" id="memoContainer">
        <div class="deposit-label">Memo (Your User ID):</div>
        <div class="deposit-value-container">
          <div class="deposit-value" id="userMemo">7206619137</div>
          <button class="copy-btn" onclick="copyToClipboard('userMemo')">Copy</button>
        </div>
      </div>
      
      <div class="note-text" id="depositNote">
        <strong>Note:</strong> Deposit only USDT/TON/DOGS (TON network).<br>
        • Memo (user id) is required to credit your account.
      </div>
    </div>
  </div>

  <!-- Withdraw Content -->
  <div class="content-container" id="withdrawContent">
    <form class="withdraw-form" id="withdrawForm" autocomplete="off">
      <div class="form-group">
        <label class="form-label" for="methodSelect">Withdraw Method</label>
        <select id="methodSelect" class="form-select" required>
          <option value="">Select Method</option>
          <option value="binance">BINANCE ID</option>
          <option value="xrocket">xRocket</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label" for="coinSelect">Coin</label>
        <select id="coinSelect" class="form-select" required>
          <option value="">Select Coin</option>
          <option value="DOGS">DOGS</option>
          <option value="USDT">USDT</option>
        </select>
        <div class="hint-text" id="coinBalanceText"></div>
      </div>
      <div class="form-group">
        <label class="form-label" for="amountInput">Amount</label>
        <input type="number" class="form-input" id="amountInput" placeholder="Enter Amount" required step="any" min="0">
        <div class="hint-text" id="amountHint">Min DOGS: 500 | Min USDT: 0.2</div>
      </div>
      <div class="form-group">
        <label class="form-label" id="idLabel" for="idInput">Binance ID/Username</label>
        <input type="text" class="form-input" id="idInput" placeholder="Enter BINANCE ID" required>
      </div>
      <button class="submit-btn" id="submitBtn" type="submit">Submit Request</button>
    </form>
    
    <!-- Withdrawal History Section -->
    <div class="history-section">
      <div class="history-header-section">
        <h3 class="history-title">Withdrawal History</h3>
        <button class="reload-btn" onclick="loadWithdrawalHistory()" title="Reload History">⟳</button>
      </div>
      <div id="historyContainer" class="history-container">
        <div class="no-history">No withdrawal history found</div>
      </div>
    </div>
  </div>
  
  <!-- Bottom Nav -->
  <div class="bottom-nav">
    <div class="nav-item nav-home" onclick="window.location.href='index.html'">
      <div class="nav-icon"></div>
      <span class="nav-label">Home</span>
    </div>
    <div class="nav-item nav-ads" onclick="window.location.href='ads.html'">
      <div class="nav-icon"></div>
      <span class="nav-label">Ads</span>
    </div>
    <div class="nav-item nav-task" onclick="window.location.href='tasks.html'">
      <div class="nav-icon"></div>
      <span class="nav-label">Tasks</span>
    </div>
    <div class="nav-item nav-wallet active" onclick="window.location.href='wallet.html'">
      <div class="nav-icon"></div>
      <span class="nav-label">Wallet</span>
    </div>
  </div>

  <!-- Firebase + Telegram Script -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getDatabase, ref, get, set, push, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
  
  const firebaseConfig = {
    apiKey: "AIzaSyDznXZYyJDmYmfWhjb3BwHa8bnu48Z0Ra4",
    authDomain: "panda-combat.firebaseapp.com",
    databaseURL: "https://panda-combat-default-rtdb.firebaseio.com",
    projectId: "panda-combat",
    storageBucket: "panda-combat.firebasestorage.app",
    messagingSenderId: "257385009837",
    appId: "1:257385009837:web:12429aa7bd48fe22baac24",
    measurementId: "G-FJB3CP1S5F"
  };
  
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  
  // --- Detect Telegram user or fallback ---
  window.Telegram.WebApp.ready();
  const tgUser = window.Telegram.WebApp.initDataUnsafe?.user;
  let userKey;
  
  if (tgUser) {
    const displayName = tgUser.username ? "@" + tgUser.username : "ID: " + tgUser.id;
    document.getElementById("id-banner").textContent = displayName;
    document.getElementById("userMemo").textContent = String(tgUser.id);
    userKey = String(tgUser.id);
  } else {
    document.getElementById("id-banner").textContent = "7206619137";
    document.getElementById("userMemo").textContent = "7206619137";
    userKey = "7206619137";
  }
  
  // --- Network and Deposit Functions ---
  window.updateDepositNetwork = function() {
    const network = document.getElementById('networkSelect').value;
    const coinSelectContainer = document.getElementById('coinSelectContainer');
    const coinSelect = document.getElementById('depositCoinSelect');
    const addressContainer = document.getElementById('addressContainer');
    const memoContainer = document.getElementById('memoContainer');
    const noteContainer = document.getElementById('depositNote');
    
    // Reset
    coinSelect.innerHTML = '<option value="">Select Coin</option>';
    addressContainer.style.display = 'none';
    memoContainer.style.display = 'none';
    noteContainer.style.display = 'none';
    
    if (network === 'TON') {
      // Show coin selection for TON
      coinSelectContainer.style.display = 'block';
      coinSelect.innerHTML = `
        <option value="">Select Coin</option>
        <option value="DOGS">DOGS</option>
        <option value="TON">TON</option>
        <option value="USDT">USDT</option>
      `;
    } else if (network === 'BEP20') {
      // Only USDT available for BEP20 and auto select
      coinSelectContainer.style.display = 'block';
      coinSelect.innerHTML = '<option value="USDT" selected>USDT</option>';
      coinSelect.value = 'USDT';
      updateDepositInfo();
    } else {
      coinSelectContainer.style.display = 'none';
    }
  };
  
  window.updateDepositInfo = function() {
    const network = document.getElementById('networkSelect').value;
    const coin = document.getElementById('depositCoinSelect').value;
    const addressContainer = document.getElementById('addressContainer');
    const memoContainer = document.getElementById('memoContainer');
    const noteContainer = document.getElementById('depositNote');
    const addressElement = document.getElementById('depositAddress');
    
    if (!network || !coin) {
      if (network === 'TON') {
        // Show address and memo for TON even without coin selection
        addressContainer.style.display = 'block';
        memoContainer.style.display = 'block';
        noteContainer.style.display = 'block';
      } else {
        addressContainer.style.display = 'none';
        memoContainer.style.display = 'none';
        noteContainer.style.display = 'none';
      }
      return;
    }
    
    if (network === 'TON') {
      // TON Network
      addressElement.textContent = 'UQCw_J1kMKQ4ikFKunOwdfgV89ZfC7pscMV3MgLhjbGdjQA7';
      addressContainer.style.display = 'block';
      memoContainer.style.display = 'block';
      noteContainer.style.display = 'block';
      noteContainer.innerHTML = `<strong>Note:</strong> Deposit only ${coin} coin on TON network.<br>Memo (user id) is required to credit your account.`;
    } else if (network === 'BEP20') {
      // BEP20 Network (BSC)
      addressElement.textContent = '0xD28dde1287f6728A66144BD9D0B1e87683fD0a4f';
      addressContainer.style.display = 'block';
      memoContainer.style.display = 'block';
      noteContainer.style.display = 'block';
      noteContainer.innerHTML = `<strong>Note:</strong> Deposit only USDT on BEP20 (BSC) network.<br>Memo (user id) is required to credit your account.`;
    }
  };

  // Modified switchTab function to reload history when switching to withdraw tab
  window.switchTab = function(tab) {
    // Remove active classes
    document.getElementById('depositTab').classList.remove('active');
    document.getElementById('withdrawTab').classList.remove('active');
    document.getElementById('depositContent').classList.remove('active');
    document.getElementById('withdrawContent').classList.remove('active');
    
    // Add active classes
    if (tab === 'deposit') {
      document.getElementById('depositTab').classList.add('active');
      document.getElementById('depositContent').classList.add('active');
    } else {
      document.getElementById('withdrawTab').classList.add('active');
      document.getElementById('withdrawContent').classList.add('active');
      // Auto-reload withdrawal history when switching to withdraw tab
      loadWithdrawalHistory();
    }
  };
  
  // --- Copy Function ---
  window.copyToClipboard = async function(elementId) {
    const text = document.getElementById(elementId).textContent;
    try {
      await navigator.clipboard.writeText(text);
      // Visual feedback
      const button = event.target;
      const originalText = button.textContent;
      button.textContent = '✓';
      button.style.background = 'linear-gradient(135deg, #059669 0%, #047857 100%)';
      setTimeout(() => {
        button.textContent = originalText;
        button.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
      }, 1000);
    } catch (err) {
      // Fallback for older browsers
      const textArea = document.createElement('textarea');
      textArea.value = text;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand('copy');
      document.body.removeChild(textArea);
      alert('Copied to clipboard!');
    }
  };
  
  // --- Balance & Withdraw Logic ---
  let userDogs = 0, userUsdt = 0.0;
  const userRef = ref(db, "users/" + userKey);
  
  async function loadBalance() {
    try {
      const snap = await get(userRef);
      if (snap.exists()) {
        userDogs = snap.val().dogs ?? 0;
        userUsdt = snap.val().usdt ?? 0.0;
      } else {
        await set(userRef, { dogs: 10, usdt: 0.00 });
        userDogs = 10; userUsdt = 0.0;
      }
      updateBalanceDisplay();
    } catch (err) {
      console.error(err);
    }
  }
  
  function updateBalanceDisplay() {
    const coinSelect = document.getElementById("coinSelect").value;
    if (coinSelect === "DOGS") {
      document.getElementById("coinBalanceText").textContent = `Your DOGS Balance: ${userDogs}`;
    } else if (coinSelect === "USDT") {
      document.getElementById("coinBalanceText").textContent = `Your USDT Balance: ${userUsdt}`;
    } else {
      document.getElementById("coinBalanceText").textContent = "";
    }
  }
  
  document.getElementById("coinSelect").addEventListener("change", updateBalanceDisplay);
  
  // --- Load Withdrawal History Function ---
  window.loadWithdrawalHistory = async function() {
    const historyContainer = document.getElementById('historyContainer');
    
    // Show loading state
    historyContainer.innerHTML = '<div class="no-history">Loading...</div>';
    
    try {
      const historyRef = ref(db, 'withdraw_requests');
      const snapshot = await get(historyRef);
      
      if (!snapshot.exists()) {
        historyContainer.innerHTML = '<div class="no-history">No withdrawal history found</div>';
        return;
      }
      
      const requests = [];
      snapshot.forEach((child) => {
        const data = child.val();
        if (data.user_id === userKey) {
          requests.push({
            id: child.key,
            ...data
          });
        }
      });
      
      if (requests.length === 0) {
        historyContainer.innerHTML = '<div class="no-history">No withdrawal history found</div>';
        return;
      }
      
      // Sort by timestamp (newest first)
      requests.sort((a, b) => new Date(b.time) - new Date(a.time));
      
      let historyHTML = '';
      requests.forEach(req => {
        const date = new Date(req.time);
        const formattedDate = date.toLocaleDateString('en-US', {
          month: 'short',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          hour12: true
        });
        
        let statusClass = 'status-pending';
        let statusText = 'Pending';
        
        if (req.status === 'completed' || req.status === 'paid') {
          statusClass = 'status-paid';
          statusText = '✅ Paid';
        } else if (req.status === 'rejected' || req.status === 'failed') {
          statusClass = 'status-rejected';
          statusText = '❌ Reject';
        } else {
          statusText = 'Pending';
        }
        
        // Truncate payout address for display
        const displayPayout = req.payout.length > 20 ? 
          req.payout.substring(0, 20) + '...' : req.payout;
        
        historyHTML += `
          <div class="history-item">
            <div class="history-header">
              <div class="history-address">${displayPayout}</div>
              <div class="history-date">${formattedDate}</div>
            </div>
            <div class="history-footer">
              <div class="history-amount">${req.amount} ${req.coin}</div>
              <div class="status-badge ${statusClass}">${statusText}</div>
            </div>
          </div>
        `;
      });
      
      historyContainer.innerHTML = historyHTML;
      
    } catch (error) {
      console.error('Error loading history:', error);
      historyContainer.innerHTML = '<div class="no-history">Error loading history</div>';
    }
  };

  // Withdraw Submit
  document.getElementById("withdrawForm").addEventListener("submit", async e => {
    e.preventDefault();
    const method = document.getElementById("methodSelect").value;
    const coin = document.getElementById("coinSelect").value;
    const amount = parseFloat(document.getElementById("amountInput").value);
    const targetId = document.getElementById("idInput").value.trim();
    
    if (!method || !coin || !amount || !targetId) {
      alert("Please complete all fields.");
      return;
    }
    
    if (coin==="DOGS" && amount<500) return alert("Minimum 500 DOGS required");
    if (coin==="USDT" && amount<0.2) return alert("Minimum 0.2 USDT required");
    if (coin==="DOGS" && amount>userDogs) return alert("Insufficient DOGS balance!");
    if (coin==="USDT" && amount>userUsdt) return alert("Insufficient USDT balance!");
    
    const reqObj = {
      user_id: userKey,
      method, coin, amount, payout: targetId,
      status: "pending",
      time: new Date().toISOString()
    };
    
    try {
      await push(ref(db, "withdraw_requests"), reqObj);
      await update(userRef, {
        dogs: coin==="DOGS" ? userDogs-amount : userDogs,
        usdt: coin==="USDT" ? userUsdt-amount : userUsdt
      });
      alert("Withdraw request submitted!");
      
      // Reload balance and history after successful submission
      await loadBalance();
      await loadWithdrawalHistory();
      
      // Clear form
      document.getElementById("withdrawForm").reset();
      updateBalanceDisplay();
    } catch (err) {
      console.error(err);
      alert("Error submitting request!");
    }
  });
  
  // Initialize on page load
  loadBalance();
  </script>
</body>
</html>
